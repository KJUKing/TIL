# 멀티 쓰레드(Multi Thread)

### 클라이언트가 요청을하고 WAS에서 응답한다. 그런데 WAS에 연결후 서블릿은 누가 호출하는걸까?

#### -> 쓰레드 : 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드
* 자바 메인 메서드를 처음 실행시 main이라는 이름의 쓰레드가 실행된다.
* 쓰레드가 없으면 자바 애플리케이션은 실행이 불가능하다.
* 쓰레드는 한번에 하나의 코드 라인만 수행한다.
* 동시 처리가 필요하면 쓰레드를 추가로 생성한다.

### 쓰레드는 하나인데 요청은 다수일때 지연이 생긴다면 임계점을 넘어 심각한 문제가 생길 수 있다 이렇다면?

#### -> 요청마다 신규 쓰레드를 생성하면된다.

요청마다 쓰레드를 생성하면 동시 요청 처리가능, 리소스 허용한계까지 처리가능, 하나의 쓰레드 지연되어도 나머지 쓰레드는 정상작동 등의 장점이 있지만,    
단점이 크리티컬하다    
일단 생성 비용은 너무비싸고, 요청이 올때마다 생성하면 응답 속도는 느려짐, 컨텍스트 스위칭(문맥교환) 비용 발생, 생성에 제한이 없어 과부하시 서버가 다운될 수 있다.

### 이 문제를 해결하기위해 쓰레드 풀을 구현한다.
* 쓰레드 풀 : pool안에 미리 쓰레드 여러개를 만들어놓고 요청시 사용, 요청후 없애는 것이아닌 pool에 반납 형식
  + 이 형식은 쓰레드의 제한을 두어 초과 요청시 대기시키거나 거절로 서버과부하를 막을 수 있고, 미리 생성되어 있으므로 쓰레드 생성 종료 비용이 절약되고 보다 빠른 응답시간의 기대를 할 수 있다.


### 쓰레드 풀 실무 팁
* WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수이다,
* 이 값을 너무 낮게 설정한다면?
  + 동시 요청이 많으면, 서버 리소스는 여유롭지만, 클라이언트는 금방 응답 지연됨.
* 이 값을 너무 높게 설정한다면?
  + 동시 요청이 많으면, cpu 메모리 리소스 임계점 초과로 서버 다운
* 장애 발생시?
  + 클라우드면 일단 서버부터 확충후, 이후에 튜닝
  + 클라우드가 아니라면 열심히 튜닝하기
 
#### 쓰레드 풀의 적정 숫자는 어떻게 찾을까?
* 애플리케이션 로직의 복잡도, cpu, 메모리, io 리소스 상황에 따라 모두 다름
* 성능 테스트
  + 최대한 실제 서비스와 유사하게 성능 테스트 시도
  + 툴: 아파치 ab, 제이미터, nGrinder




